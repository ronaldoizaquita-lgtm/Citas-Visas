<?php
// =========================
//  Gestión de datos (PHP)
// =========================

$file = "citas.json";

// Si el archivo no existe, lo crea
if(!file_exists($file)){
    file_put_contents($file, "[]");
}

// Leer citas
$data = json_decode(file_get_contents($file), true);

// Guardar cita
if(isset($_POST["action"]) && $_POST["action"] === "save"){
    $new = [
        "fullName" => $_POST["fullName"],
        "email" => $_POST["email"],
        "phone" => $_POST["phone"],
        "passport" => $_POST["passport"],
        "visaType" => $_POST["visaType"],
        "date" => $_POST["date"],
        "time" => $_POST["time"],
        "notes" => $_POST["notes"]
    ];
    $data[] = $new;
    file_put_contents($file, json_encode($data, JSON_PRETTY_PRINT));
    header("Location: index.php?ok=1");
    exit;
}

// Borrar todas
if(isset($_GET["deleteAll"])){
    file_put_contents($file, "[]");
    header("Location: index.php");
    exit;
}

// Exportar CSV
if(isset($_GET["export"])){
    header("Content-Type: text/csv");
    header("Content-Disposition: attachment; filename=citas.csv");
    $f = fopen("php://output", "w");
    fputcsv($f, ["Nombre","Correo","Teléfono","Pasaporte","Visa","Fecha","Hora","Notas"]);
    foreach($data as $c){
        fputcsv($f, [
            $c["fullName"], $c["email"], $c["phone"], $c["passport"],
            $c["visaType"], $c["date"], $c["time"], $c["notes"]
        ]);
    }
    exit;
}
?>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agenda de Visas - ECCI</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --ecci-blue:#003788;
  --bg:#f7f9fc;
  --card:#ffffff;
  --muted:#6b7280;
  --radius:14px;
}

body{
  margin:0;
  padding:32px;
  background:var(--bg);
  font-family:"Inter",sans-serif;
  color:#0f172a;
  display:flex;
  justify-content:center;
}

.container{
  max-width:1100px;
  width:100%;
  display:grid;
  grid-template-columns:1fr 380px;
  gap:24px;
}

@media(max-width:900px){
  .container{ grid-template-columns:1fr }
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:22px;
  box-shadow:0 8px 28px rgba(0,0,0,0.06);
}

.header{ grid-column:1 / -1; }
.header h1{ margin:0; color:var(--ecci-blue);}
.header p{ margin:0; font-size:14px; color:var(--muted); }

input, select, textarea{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #cfd6e4;
  font-size:15px;
  box-sizing:border-box;
}

.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

@media(max-width:600px){
  .row{ grid-template-columns:1fr }
}

.btn{
  padding:10px 14px;
  border-radius:10px;
  cursor:pointer;
  border:none;
  font-weight:600;
}

.btn.primary{ background:var(--ecci-blue); color:white; }
.btn.ghost{ background:white; border:1px solid #ddd; }
.btn.danger{ background:#d92b2b; color:white; }

.appointment{
  border:1px solid #e3e6ef;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h1>Agenda de Visas – ECCI</h1>
    <p>Gestión de citas y movilidad internacional</p>
  </div>

  <!-- FORMULARIO -->
  <section class="card">
    <h2 style="color:var(--ecci-blue); margin-top:0">Agendar Cita</h2>

    <?php if(isset($_GET["ok"])): ?>
      <p style="color:green;font-weight:600">✔ Cita guardada correctamente</p>
    <?php endif; ?>

    <form method="POST">

      <input type="hidden" name="action" value="save">

      <div class="row">
        <div>
          <label>Nombre completo *</label>
          <input name="fullName" required>
        </div>
        <div>
          <label>Correo *</label>
          <input type="email" name="email" required>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Teléfono / WhatsApp *</label>
          <input name="phone" required>
        </div>
        <div>
          <label>Pasaporte</label>
          <input name="passport">
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Tipo de Visa *</label>
        <select name="visaType" required>
          <option value="">Seleccione</option>
          <option>Turismo</option>
          <option>Estudios</option>
          <option>Trabajo</option>
          <option>Intercambio</option>
          <option>Otro</option>
        </select>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Fecha *</label>
          <input type="date" name="date" required>
        </div>
        <div>
          <label>Hora *</label>
          <input type="time" name="time" required>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Notas</label>
        <textarea name="notes" rows="3"></textarea>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn primary" type="submit">Guardar</button>
        <button class="btn ghost" type="reset">Limpiar</button>
      </div>

    </form>
  </section>

  <!-- LISTA -->
  <aside class="card">
    <h2 style="color:var(--ecci-blue); margin-top:0">Citas Guardadas</h2>

    <input id="search" placeholder="Buscar..." style="margin-bottom:10px">

    <div id="list">
      <?php if(count($data)==0): ?>
          <p style="color:#888">No hay citas registradas.</p>
      <?php endif; ?>

      <?php foreach($data as $c): ?>
        <div class="appointment">
          <strong><?= $c["fullName"] ?></strong><br>
          <span><?= $c["visaType"] ?> – <?= $c["date"] ?> <?= $c["time"] ?></span><br>
          <span><?= $c["email"] ?></span><br><br>

          <button class="btn ghost" onclick="openWhats('<?= $c['phone'] ?>','<?= $c['fullName'] ?>')">
            WhatsApp
          </button>
        </div>
      <?php endforeach; ?>
    </div>

    <div style="display:flex; gap:10px; margin-top:12px">
      <a class="btn ghost" href="index.php?export">Exportar CSV</a>
      <a class="btn danger" href="index.php?deleteAll" onclick="return confirm('¿Eliminar todas las citas?')">Borrar Todo</a>
    </div>
  </aside>

</div>

<script>
function openWhats(phone, name){
  const msg = encodeURIComponent(`Hola, soy ${name} y deseo información sobre mi cita de visa.`);
  window.open(`https://wa.me/${phone}?text=${msg}`, "_blank");
}

const search = document.getElementById("search");
const list = document.getElementById("list");
search.addEventListener("input", ()=>{
  let q = search.value.toLowerCase();
  document.querySelectorAll(".appointment").forEach(div=>{
    div.style.display = div.innerText.toLowerCase().includes(q) ? "" : "none";
  });
});
</script>

</body>
</html>
